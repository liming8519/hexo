---
title:  docker 部署笔记
tags:
- tool
categories: 
- linux 
date: 2019-11-05 02:00:00
---
> docker 部署笔记
<!-- more -->

### docker指定私有库

```

[root@cloudsa ~]# vi /etc/docker/daemon.json
{
    "registry-mirror":["http://192.168.106.117"],
    "insecure-registries":["192.168.106.117"]
}
[root@cloudsa ~]# systemctl daemon-reload
[root@cloudsa ~]# systemctl stop docker
[root@cloudsa ~]# systemctl start docker
[root@cloudsa ~]# systemctl status docker
[root@cloudsa ~]# docker login 192.168.106.117
[root@cloudsa ~]# cat /root/.docker/config.json 
{
        "auths": {
                "192.168.106.117": {
                        "auth": "YWRtaW46SGFyYm9yMTIzNDU="
                }
        },
        "HttpHeaders": {
                "User-Agent": "Docker-Client/19.03.0 (linux)"
        }
}
上面把密码拷贝到其他机器中
下面是上传文件测试
[root@managementa harbor]# docker tag centos 192.168.106.117/library/centos:latest
[root@managementa harbor]# docker push 192.168.106.117/library/centos:latest
```
### 离线redis制作

```
从docker.io拉取
[root@managementa harbor]# docker pull redis:3.2.9  
[root@managementa local]# docker tag redis:3.2.9 192.168.106.117/library/redis:3.2.9
[root@managementa local]# docker push 192.168.106.117/library/redis:3.2.9
```
### redis主备

```
192.168.106.103
[root@managementa local]# cat cd /home/redis_copy/docker/redis-master.conf
#master
port 6379
bind 0.0.0.0
#daemonize yes 不能后台执行，后台执行docker会一直重启
logfile "redis6500.log"
pidfile "6500.pid"
#cluster-enabled yes
#cluster-config-file nodes_7000.conf
#cluster-node-timeout 15000
#appendonly yes
masterauth "123456"
requirepass "123456"
#slave-read-only no
timeout 0
rdbcompression yes
dbfilename "redis.rdb"
dir "/data"
maxmemory 50gb
maxmemory-policy noeviction
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit slave 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60
# Generated by CONFIG REWRITE

notify-keyspace-events "gxE"

[root@localhost testworkdir]# pwd
/root/testworkdir
[root@localhost testworkdir]# vi compose-redis-master.yaml
version: '3'
services:
  # 主节点的容器
  redis-master:
    image: 192.168.106.117/library/redis:3.2.9
    container_name: redis-master
    restart: always
    ports:
      - 6500:6379
    networks:
      redis-cluster:
        # 为容器指定一个静态IP,指定redis网络为10.1.100.0/24
        ipv4_address: 10.1.100.2
    environment:
      TZ: "Asia/Shanghai"
    volumes:
      # 映射配置文件和数据目录
      - /home/redis_copy/6500/redis-master.conf:/usr/local/etc/redis/redis.conf
      - /home/redis_copy/6500/data:/data
    sysctls:
      # 必要的内核参数
      net.core.somaxconn: '511'
    command: ["redis-server", "/usr/local/etc/redis/redis.conf"]
networks:
  redis-cluster:
    # IP Address Management
    ipam:
      config:
        # 为容器分配一个独立的子网，用来方便为容器指定静态IP
        # 使用独立的子网可以避免IP地址冲突的问题
        - subnet: 10.1.100.0/16

[root@localhost testworkdir]# docker-compose -f compose-redis-master.yaml up -d


192.168.106.130从结点
[root@localhost testworkdir]# vi compose-redis-slave.yaml 
version: '3.5'
services:
  # 主节点的容器
  redis-slave:
    image: 192.168.106.117/library/redis:3.2.9
    container_name: redis-slave
    restart: always
    ports:
      - 6500:6379
    networks:
      redis-cluster:
        # 为容器指定一个静态IP,指定redis网络为10.1.100.0/24
        ipv4_address: 10.1.100.3
    environment:
      TZ: "Asia/Shanghai"
    volumes:
      # 映射配置文件和数据目录
      - /home/redis_copy/6500/redis-slave.conf:/usr/local/etc/redis/redis.conf
      - /home/redis_copy/6500/data:/data
    sysctls:
      # 必要的内核参数
      net.core.somaxconn: '511'
    command: ["redis-server","/usr/local/etc/redis/redis.conf"]
networks:
  redis-cluster:
    # IP Address Management
    ipam:
      config:
        # 为容器分配一个独立的子网，用来方便为容器指定静态IP
        # 使用独立的子网可以避免IP地址冲突的问题
        - subnet: 10.1.0.0/16

[root@localhost testworkdir]# cat /home/redis_copy/6500/redis-slave.conf
port 6379
bind 0.0.0.0
#daemonize yes
logfile "redis6500.log"
pidfile "6500.pid"
#cluster-enabled yes
#cluster-config-file nodes_7000.conf
#cluster-node-timeout 15000
#appendonly yes
masterauth "123456"
requirepass "123456"

slave-read-only yes
slave-priority 100

timeout 0
rdbcompression yes
dbfilename "redis.rdb"
dir "/data"
maxmemory 50gb
maxmemory-policy noeviction
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit slave 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60
slaveof 10.1.100.2 6379
# Generated by CONFIG REWRITE

[root@localhost testworkdir]# docker-compose -f compose-redis-slave.yaml up -d


10.1.100.2与10.1.100.3结点通信
ovs
192.168.106.103配置
[root@localhost ~]# ovs-vsctl add-br redis-br0
[root@localhost ~]# ovs-vsctl add-port redis-br0 redis-gre0 -- set interface redis-gre0 type=gre options:remote_ip=192.168.106.130
[root@localhost ~]# ip link add redis-veth0 type veth peer name redis-veth1
[root@localhost ~]# ovs-vsctl add-port redis-br0 redis-veth1
[root@localhost ~]# ip l set redis-veth0 master br-b1b46f782738
[root@localhost ~]# ip l set redis-veth0 up 
[root@localhost ~]# ip l set redis-veth1 up  
192.168.106.130配置
[root@localhost ~]# ovs-vsctl add-br redis-br0
[root@localhost ~]# ovs-vsctl add-port redis-br0 redis-gre0 -- set interface redis-gre0 type=gre options:remote_ip=192.168.106.103
[root@localhost ~]# ip link add redis-veth0 type veth peer name redis-veth1
[root@localhost ~]# ovs-vsctl add-port redis-br0 redis-veth1
[root@localhost ~]# ip l set redis-veth0 master br-3d50b82c9cb2
[root@localhost ~]# ip l set redis-veth0 up 
[root@localhost ~]# ip l set redis-veth1 up  

**重启docker会重载iptables配置**


哨兵配置192.168.106.130
[root@localhost testworkdir]# mkdir -p /home/redis_copy/6600/data
[root@localhost testworkdir]# cd /home/redis_copy/6600/
[root@localhost 6600]# vi sentinel.conf
port 6379
#daemonize yes
protected-mode no
logfile "sentinel.log"
dir "/data"
sentinel myid bf64f29ff9578fb293d5d90ec85d083e2ae03725
sentinel monitor mymaster 10.1.100.2 6379 1
sentinel down-after-milliseconds mymaster 5000
sentinel failover-timeout mymaster 18000
sentinel auth-pass mymaster 123456
# Generated by CONFIG REWRITE
sentinel config-epoch mymaster 7105
sentinel leader-epoch mymaster 8690
sentinel known-slave mymaster 10.1.100.3 6379
sentinel current-epoch 8690


[root@localhost 6600]# cd /root/testworkdir/

[root@localhost testworkdir]# vi compose-redis-slave.yaml
只提取下面的service放到文件compose-redis-slave.yaml的service下
version: '3.5'
services:
  # 主节点的容器
  redis-sentinel:
    image: 192.168.106.117/library/redis:3.2.9
    container_name: redis-sentinel
    restart: always
    ports:
      - 6600:6379
    networks:
      redis-cluster:
        # 为容器指定一个静态IP,指定redis网络为10.1.100.0/24
        ipv4_address: 10.1.100.4
    environment:
      TZ: "Asia/Shanghai"
    volumes:
      # 映射配置文件和数据目录
      - /home/redis_copy/6600/sentinel.conf:/usr/local/etc/redis/redis.conf
      - /home/redis_copy/6600/data:/data
    sysctls:
      # 必要的内核参数
      net.core.somaxconn: '511'
    command: ["redis-sentinel","/usr/local/etc/redis/redis.conf"]
networks:
  redis-cluster:
    # IP Address Management
    ipam:
      config:
        # 为容器分配一个独立的子网，用来方便为容器指定静态IP
        # 使用独立的子网可以避免IP地址冲突的问题
        - subnet: 10.1.0.0/16
[root@localhost testworkdir]# docker-compose -f compose-redis-slave.yaml up -d redis-sentinel
[root@localhost testworkdir]# docker-compose -f compose-redis-slave.yaml ps
     Name                   Command               State           Ports         
--------------------------------------------------------------------------------
redis-sentinel   docker-entrypoint.sh redis ...   Up      0.0.0.0:6600->6379/tcp
redis-slave      docker-entrypoint.sh redis ...   Up      0.0.0.0:6500->6379/tcp


[root@localhost testworkdir]# cat compose-redis-slave.yaml 
version: '3.5'
services:
  # 主节点的容器
  redis-slave:
    image: 192.168.106.117/library/redis:3.2.9
    container_name: redis-slave
    restart: always
    ports:
      - 6500:6379
    networks:
      redis-cluster:
        # 为容器指定一个静态IP,指定redis网络为10.1.100.0/24
        ipv4_address: 10.1.100.3
    environment:
      TZ: "Asia/Shanghai"
    volumes:
      # 映射配置文件和数据目录
      - /home/redis_copy/6500/redis-slave.conf:/usr/local/etc/redis/redis.conf
      - /home/redis_copy/6500/data:/data
    sysctls:
      # 必要的内核参数
      net.core.somaxconn: '511'
    command: ["redis-server","/usr/local/etc/redis/redis.conf"]
  redis-sentinel:
    image: 192.168.106.117/library/redis:3.2.9
    container_name: redis-sentinel
    restart: always
    ports:
      - 6600:6379
    networks:
      redis-cluster:
        # 为容器指定一个静态IP,指定redis网络为10.1.100.0/24
        ipv4_address: 10.1.100.4
    environment:
      TZ: "Asia/Shanghai"
    volumes:
      # 映射配置文件和数据目录
      - /home/redis_copy/6600/sentinel.conf:/usr/local/etc/redis/redis.conf
      - /home/redis_copy/6600/data:/data
    sysctls:
      # 必要的内核参数
      net.core.somaxconn: '511'
    command: ["redis-sentinel","/usr/local/etc/redis/redis.conf"]
networks:
  redis-cluster:
    # IP Address Management
    ipam:
      config:
        # 为容器分配一个独立的子网，用来方便为容器指定静态IP
        # 使用独立的子网可以避免IP地址冲突的问题
        - subnet: 10.1.0.0/16
```

### 离线tomcat
```
[root@managementa harbor]# docker pull tomcat:8.5.35
[root@managementa harbor]# docker tag tomcat:8.5.35 192.168.106.117/library/tomcat:8.5.35
[root@managementa harbor]# docker push 192.168.106.117/library/tomcat:8.5.35
The push refers to repository [192.168.106.117/library/tomcat]
a836e69a477e: Pushed 
fb14b3adeb79: Pushed 
ab42adfb0c2b: Pushed 
704398ab3f1e: Pushed 
d4397eab7439: Pushed 
e8995be06405: Pushed 
586032a40815: Pushing [==================================================>]  316.9MB
86becce36874: Pushed 
360cf37035a0: Pushed 
1850621c23b2: Pushed 
8f7ee6d76fd9: Pushed 
c23711a84ad4: Pushed 
90d1009ce6fe: Pushed 

```
### tomcat服务

```
192.168.106.118配置
[root@cloudsa ~]# mkdir testworkdir
[root@cloudsa ~]# cd testworkdir/
[root@cloudsa testworkdir]# vi compose-tomcat.yaml
version: '3.5'
services:
  tomcat-infomanagesystem:
    image: 192.168.106.117/library/tomcat:8.5.35
    container_name: tomcat-infomanagesystem
    restart: always
    ports:
      - 28009:8080
    networks:
      tomcat-cluster:
        # 为容器指定一个静态IP,指定redis网络为10.1.100.0/24
        ipv4_address: 10.1.101.2
    environment:
      TZ: "Asia/Shanghai"
    volumes:
      # 映射配置文件和数据目录
      - /home/cetc54/InforManageSystem/apache-tomcat-8.5.35/webapps:/usr/local/tomcat/webapps
      - /home/cetc54/InforManageSystem/apache-tomcat-8.5.35/logs:/usr/local/tomcat/logs
      - /home/cetc54/InfoVeriManageSystem/apache-tomcat-8.5.35/guns-logs:/usr/local/tomcat/guns-logs
    sysctls:
      # 必要的内核参数
      net.core.somaxconn: '511'

  tomcat-infoverisystem:
    image: 192.168.106.117/library/tomcat:8.5.35
    container_name: tomcat-infoverisystem
    restart: always
    ports:
      - 8000:8080
    networks:
      tomcat-cluster:
        # 为容器指定一个静态IP,指定redis网络为10.1.100.0/24
        ipv4_address: 10.1.101.3
    environment:
      TZ: "Asia/Shanghai"
    volumes:
      # 映射配置文件和数据目录
      - /home/cetc54/InfoVeriManageSystem/apache-tomcat-8.5.35/webapps:/usr/local/tomcat/webapps
      - /home/cetc54/InfoVeriManageSystem/apache-tomcat-8.5.35/logs:/usr/local/tomcat/logs
      - /home/cetc54/InfoVeriManageSystem/apache-tomcat-8.5.35/guns-logs:/usr/local/tomcat/guns-logs
    sysctls:
      # 必要的内核参数
      net.core.somaxconn: '511'

  tomcat-infoverisynsystem:
    image: 192.168.106.117/library/tomcat:8.5.35
    container_name: tomcat-infoverisynsystem
    restart: always
    ports:
      - 9000:8080
    networks:
      tomcat-cluster:
        # 为容器指定一个静态IP,指定redis网络为10.1.100.0/24
        ipv4_address: 10.1.101.4
    environment:
      TZ: "Asia/Shanghai"
    volumes:
      # 映射配置文件和数据目录
      - /home/cetc54/infoVeriSyncService/apache-tomcat-8.5.35/webapps:/usr/local/tomcat/webapps
      - /home/cetc54/infoVeriSyncService/apache-tomcat-8.5.35/logs:/usr/local/tomcat/logs
      - /home/cetc54/infoVeriSyncService/apache-tomcat-8.5.35/guns-logs:/usr/local/tomcat/guns-logs
    sysctls:
      # 必要的内核参数
      net.core.somaxconn: '511'



networks:
  tomcat-cluster:
    # IP Address Management
    ipam:
      config:
        # 为容器分配一个独立的子网，用来方便为容器指定静态IP
        # 使用独立的子网可以避免IP地址冲突的问题
        - subnet: 10.1.0.0/16
[root@cloudsa testworkdir]# docker-compose -f compose-tomcat.yaml up -d




192.168.106.119配置
[root@cloudsa ~]# mkdir testworkdir
[root@cloudsa ~]# cd testworkdir/
[root@cloudsa testworkdir]# vi compose-tomcat.yaml
version: '3.5'
services:
  tomcat-infoverisystem:
    image: 192.168.106.117/library/tomcat:8.5.35
    container_name: tomcat-infoverisystem
    restart: always
    ports:
      - 8000:8080
    networks:
      tomcat-cluster:
        # 为容器指定一个静态IP,指定redis网络为10.1.100.0/24
        ipv4_address: 10.1.101.3
    environment:
      TZ: "Asia/Shanghai"
    volumes:
      # 映射配置文件和数据目录
      - /home/cetc54/InfoVeriManageSystem/apache-tomcat-8.5.35/webapps:/usr/local/tomcat/webapps
      - /home/cetc54/InfoVeriManageSystem/apache-tomcat-8.5.35/logs:/usr/local/tomcat/logs
      - /home/cetc54/InfoVeriManageSystem/apache-tomcat-8.5.35/guns-logs:/usr/local/tomcat/guns-logs
    sysctls:
      # 必要的内核参数
      net.core.somaxconn: '511'

  tomcat-infoverisynsystem:
    image: 192.168.106.117/library/tomcat:8.5.35
    container_name: tomcat-infoverisynsystem
    restart: always
    ports:
      - 9000:8080
    networks:
      tomcat-cluster:
        # 为容器指定一个静态IP,指定redis网络为10.1.100.0/24
        ipv4_address: 10.1.101.4
    environment:
      TZ: "Asia/Shanghai"
    volumes:
      # 映射配置文件和数据目录
      - /home/cetc54/infoVeriSyncService/apache-tomcat-8.5.35/webapps:/usr/local/tomcat/webapps
      - /home/cetc54/infoVeriSyncService/apache-tomcat-8.5.35/logs:/usr/local/tomcat/logs
      - /home/cetc54/infoVeriSyncService/apache-tomcat-8.5.35/guns-logs:/usr/local/tomcat/guns-logs
    sysctls:
      # 必要的内核参数
      net.core.somaxconn: '511'



networks:
  tomcat-cluster:
    # IP Address Management
    ipam:
      config:
        # 为容器分配一个独立的子网，用来方便为容器指定静态IP
        # 使用独立的子网可以避免IP地址冲突的问题
        - subnet: 10.1.0.0/16
[root@cloudsa testworkdir]# docker-compose -f compose-tomcat.yaml up -d
```